---
title: "Reproducible Research: Peer Assessment 1"
output: 
  html_document:
    keep_md: true
---
## Executive Summary
<= 10 complete sentences

## Questions this study considers

  1. Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?
  1. Across the United States, which types of events have the greatest economic consequences?

## Processing the data set
## Overview of the data set
### Loading the data
```{r}
dseturl <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
dsetzip <- "data/StormData.csv.bz2"
dsetrds <- "data/StormData.RDS"

if (!file.exists(dsetzip)) {
    download.file(url = dseturl,
                  destfile = dsetzip,
                  method = "curl")
}

d <- read.csv(file = bzfile(dsetzip), strip.white = TRUE)


```

## Cleaning the data

Because we want to determine the most costly disasters, we have to
examine the the property damage (`PROPDMG`) and crop damage
(`CROPDMG`) values.  These are simple integers which must be
multiplied by an exponent given in another field (`PROPDMGEXP` and
`CROPDMGEXP` respectively.  Unfortunately, not all of the exponent
values are valid; many appear to be rounding or entry errors from
older entry systems.

For the purposes of this study, we accept only the following values
for exponent:
  * H hundred (x100)
  * K thousand (x1,000)
  * M million (x1,000,000)
  * B billion (x1,000,000,000)

```{r}
gortexp <- function(dmgexp) dmgexp <- switch(toupper(dmgexp), H=100, K=1000, M=1000000, B=1000000000, 1)
d$pdmgUSD <- mapply(gortexp, d$PROPDMG, d$PROPDMGEXP)
d$cdmgUSD <- mapply(gortexp, d$CROPDMG, d$CROPDMGEXP)
```

To assist in date analysis, we will convert dates to POSIXct format

```{r}
d$BEGIN_UTC <- mdy(str_extract(d$BGN_DATE, "[^ ]+")
```

The manual entry nature of the data causes huge difficulties in categorizing events.  For example, you will find high wind events entered in completely arbitrary ways, mixing terminology, abbreviations, upper and lower case etc. (`thunderstorm`, `gusty thundertorm wind`, `gusty wind/rain`, `marine tstm wind`).  We are going to attempt to categorize the most impactful events by looking for common words and abbreviations in a relative handful of weather categories:

| category     | regexp                                              |
| -----------  | -------------------------------------------------   |
| excluded     | ^non*                                               |
| fire         |                                                     |
| thunderstorm | *thunder*,tstm*,*lightning*                         |
| wind/tornado | tornado*, wind,^hurricane, *funnel*                 |
| winter       | *snow*,*winter*,*blizzard*,*sleet*, *cold*          |
| ice          | ^ice*,*freeze*                                      |
| rain         | *rain*,*flood*, *wet*                               |
| ocean surge  | *surf*,*surge*,*tide*,*tsunami*,*current*           |
| volcano      | *volcan*                                            |
| heat         | *heat*, *high\stemp*, *record\stemp*, *warm*, *dry* |


## USA is defined as the 50 states in the continental US, plus DC, HI and AK; territories, protectorates, and military regions are excluded
d$isUSA <- mapply( function(st) st %in% state.abb, d$STATE )
```

In the interest of performance, we will save the data frame as an R data set (`.RDS` file)
```{r}
saveRDS(d, file=dsetrds)
d <- readRDS(dsetrds)
```

## Results
  1. Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?



## Appendix
### Utility functions
Some functions were used to clean up and normalize the data used in this analysis.  Those functions are defined here

```{r}
## timeconv() is used to take inconsistent times and convert them to a standard format
## times will either be 24-hour HHMM ("1330") or 12-hour strings with AM/PM ("01:30:00 PM")
## functions returns format of 24-hour HH:MM:SS ("13:30:00")
timeconv <- function(x) {
    if (nchar(x) == 4) {
        paste(substr(x,1,2), substr(x,3,4), "00", sep=":")
    } else {
        timeadd <- 1
        if (substr(x,nchar(x)-1,nchar(x)) == "PM") timeadd <- 12
        paste0(
            formatC(as.integer(substr(x,1,2)) + timeadd, width=2, format="d", flag="0"),
            substr(x,3,nchar(x)-3))
    }
}

```

